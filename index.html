<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Blackjack Deluxe â€” GitHub Pages</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1: #071422;
    --bg-2: #072a2b;
    --panel: rgba(255,255,255,0.05);
    --accent: #ffd166;
    --accent-2: #06d6a0;
    --muted:#9fd8c8;
    --card-white:#ffffff;
    --shadow: 0 10px 30px rgba(2,6,23,0.6);
    --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background: radial-gradient(1200px 500px at 10% 10%, rgba(6,40,42,0.55), transparent),
                linear-gradient(180deg,var(--bg-1),var(--bg-2));
    color:var(--muted);
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    display:flex;align-items:center;justify-content:center;padding:28px;
  }

  /* App */
  .app{
    width:100%; max-width:1200px; border-radius:14px; overflow:hidden;
    box-shadow:var(--shadow);
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    display:grid;
    grid-template-columns: 340px 1fr;
    gap:18px;
    padding:18px;
  }
  @media (max-width:980px){ .app{ grid-template-columns: 1fr; } }

  /* LEFT: Setup / Controls */
  .sidebar{
    background:var(--panel); padding:14px; border-radius:10px; height:100%;
    display:flex;flex-direction:column; gap:12px;
  }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo{
    width:58px; height:58px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#ff9f1c);
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#0b2221;
    box-shadow:0 6px 20px rgba(255,145,56,0.12); font-size:1.15rem;
  }
  h1{ margin:0; font-size:1.05rem; color:var(--accent); }
  .muted{ color:#bfeee1; font-size:0.9rem; }

  .control-row{ display:flex; gap:8px; align-items:center; }
  label{ font-size:0.88rem; color:var(--muted); }
  select,input[type=number],input[type=text]{
    background:transparent;border:1px solid rgba(255,255,255,0.06); padding:8px;border-radius:8px;color:var(--muted);
  }
  button.primary{
    background: linear-gradient(90deg,var(--accent), #ff9f1c);
    border:none;color:#041212;padding:10px;border-radius:10px;font-weight:700;cursor:pointer;
  }
  button.ghost{ background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:8px;border-radius:8px; }

  .players-list{ display:flex; flex-direction:column; gap:10px; margin-top:6px; max-height:320px; overflow:auto; padding-right:6px; }
  .player-config{ display:flex; gap:8px; align-items:center; background: rgba(0,0,0,0.12); padding:8px;border-radius:8px; }
  .player-config input[type=text]{ flex:1; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--muted) }

  .small{ font-size:0.85rem; color:#cdeee0; }

  /* RIGHT: Game table */
  .table-wrap{ display:flex; flex-direction:column; gap:12px; }
  .table-header{ display:flex; justify-content:space-between; align-items:center; }
  .chips-bank{ display:flex; gap:10px; align-items:center; }
  .bank{ background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); padding:8px 12px; border-radius:10px; font-weight:700; color:var(--accent-2); }

  .board{
    background: linear-gradient(180deg, rgba(2,18,16,0.25), rgba(2,18,16,0.35));
    border-radius:12px; padding:18px; display:flex; flex-direction:column; gap:12px;
    min-height:420px;
    box-shadow: inset 0 2px 0 rgba(255,255,255,0.02);
  }

  /* Player lanes */
  .lane{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; padding:10px; border-radius:10px; }
  .lane.human{ background: linear-gradient(90deg, rgba(255,255,255,0.018), rgba(255,255,255,0.01)); }
  .lane.dealer{ background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px dashed rgba(255,255,255,0.03); }

  .player-meta{ display:flex; flex-direction:column; gap:6px; min-width:180px; }
  .player-title{ font-weight:800; color:var(--accent); display:flex; gap:8px; align-items:center; }
  .player-sub{ color:#bfeee1; font-size:0.9rem; }

  .hand-area{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

  /* Card style using CSS + small suit icons */
  .card{
    width:84px; height:120px; border-radius:10px; background:var(--card-white); color:#000; display:flex; flex-direction:column;
    justify-content:space-between; padding:8px; box-shadow: 0 8px 18px rgba(2,8,16,0.6); transform:translateZ(0);
    transition: transform 260ms cubic-bezier(.2,.9,.3,1), box-shadow 180ms;
    will-change: transform;
    position:relative;
    user-select:none;
  }
  .card .rank { font-weight:800; font-size:1.05rem; }
  .card .suit { font-size:1.4rem; opacity:0.95; }
  .card.red .rank, .card.red .suit { color:#b30d0d; }
  .card.hidden{ background: linear-gradient(135deg,#122a2a,#051116); color:transparent; box-shadow:none; transform:rotateY(180deg); }
  .card.faceup{ animation: pop 260ms ease both; }
  @keyframes pop{ from { transform: translateY(18px) scale(.95); opacity:0 } to { transform: translateY(0) scale(1); opacity:1 } }

  /* Controls below board */
  .actions-row{ display:flex; gap:10px; align-items:center; margin-top:8px; }
  .chip{ background:linear-gradient(180deg,#fff,#ddd); padding:8px 10px; border-radius:999px; font-weight:800; color:#042; cursor:pointer; box-shadow:0 6px 16px rgba(2,8,10,0.25); }
  .chip.active{ box-shadow:0 10px 30px rgba(3,120,100,0.18); transform:translateY(-4px); }

  .panel-bottom{ display:flex; justify-content:space-between; align-items:center; margin-top:6px; }

  /* Log */
  .log{ background:rgba(0,0,0,0.18); padding:10px; border-radius:8px; max-height:140px; overflow:auto; font-size:0.9rem; color:#d9fcf0; }

  /* subtle button styles */
  .btn-small{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
  .btn-hit{ background:#06d6a0; color:#042; }
  .btn-stand{ background:#ffd166; color:#041212; }
  .btn-double{ background:#f97316; color:white; }
  .btn-split{ background:#6b21a8; color:white; }
  .btn-insure{ background:#0ea5a4; color:white; }

  /* overlay to hide setup during play */
  .hide-during-play{ transition: opacity 260ms; }

  /* responsive */
  @media (max-width:680px){
    .card{ width:64px; height:94px; }
    .player-meta{ min-width:120px; }
  }

</style>
</head>
<body>
<div class="app" id="app">

  <!-- SIDEBAR / SETUP -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">BJ</div>
      <div>
        <h1>Blackjack Deluxe</h1>
        <div class="muted">Hotseat Â· Bots Â· GitHub Pages</div>
      </div>
    </div>

    <div class="small">Modus</div>
    <div class="control-row">
      <select id="mode">
        <option value="vsDealer" selected>Gegen Dealer (klassisch)</option>
        <option value="free">Mehrspieler (gegenseitig)</option>
      </select>
      <div style="flex:1"></div>
      <button class="ghost" id="setupBtn">Setup erzeugen</button>
    </div>

    <div class="small">Spieleranzahl</div>
    <div class="control-row">
      <input id="numPlayers" type="number" min="1" max="5" value="2" />
      <select id="defaultBotRate" title="Wieviele der Spieler als Bot vorkonfigurieren">
        <option value="0">0 Bots</option>
        <option value="1">1 Bot</option>
        <option value="2">2 Bots</option>
      </select>
      <div style="flex:1"></div>
      <button class="primary" id="startBtn">Spiel starten</button>
    </div>

    <div class="small">Spieler</div>
    <div class="players-list" id="playersConfig"></div>

    <div style="display:flex;gap:8px;align-items:center;">
      <div class="small">Bank / Startguthaben</div>
      <input id="startBank" type="number" value="1000" min="0" style="width:110px" />
    </div>

    <div class="small">Hinweise</div>
    <div class="muted" style="font-size:0.88rem">
      Split: erlaubt nur bei Paaren; Double: nur auf 2 Karten; Insurance: verfÃ¼gbar, wenn Dealer Ass. Bots nutzen einfache Basisheuristik.
    </div>

    <div style="margin-top:auto;">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
        <div class="muted">Version</div>
        <div class="muted">Deluxe v1.0</div>
      </div>
    </div>
  </aside>

  <!-- BOARD -->
  <main class="table-wrap">
    <div class="table-header">
      <div class="chips-bank">
        <div class="bank" id="globalBank">Bank: â€”</div>
        <div class="muted" style="margin-left:8px">WÃ¤hle Einsatz / Chips</div>
      </div>
      <div>
        <button class="ghost" id="resetBtn">Neu laden</button>
        <button class="ghost" id="muteBtn">ðŸ”Š</button>
      </div>
    </div>

    <section class="board" id="board">
      <!-- Dealer Lane -->
      <div class="lane dealer" id="dealerLane">
        <div class="player-meta">
          <div class="player-title">Dealer</div>
          <div class="player-sub" id="dealerSub">Bereit</div>
        </div>
        <div class="hand-area" id="dealerHands"></div>
        <div style="min-width:120px; text-align:right;"><div id="dealerValue" class="small"></div></div>
      </div>

      <!-- Player lanes dynamic -->
      <div id="playersLanes" style="display:flex;flex-direction:column;gap:10px;"></div>

      <!-- bottom controls -->
      <div class="panel-bottom">
        <div style="display:flex;gap:10px;align-items:center;">
          <div class="chip" data-value="10">10</div>
          <div class="chip" data-value="25">25</div>
          <div class="chip" data-value="50">50</div>
          <div class="chip" data-value="100">100</div>
          <div class="chip" data-value="500">500</div>
        </div>
        <div>
          <button class="btn-small btn-hit" id="btnHit">Hit</button>
          <button class="btn-small btn-stand" id="btnStand">Stand</button>
          <button class="btn-small btn-double" id="btnDouble">Double</button>
          <button class="btn-small btn-split" id="btnSplit">Split</button>
          <button class="btn-small btn-insure" id="btnInsure">Insurance</button>
        </div>
      </div>

      <h4 style="margin-top:8px">Protokoll</h4>
      <div class="log" id="log"></div>
    </section>

    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;">
      <div class="muted">Tipp: Auf MobilgerÃ¤ten Bildschirm drehen fÃ¼r beste Ansicht.</div>
      <div>
        <button class="primary" id="dealBtn" disabled>Geben</button>
        <button class="ghost" id="nextBtn" disabled>NÃ¤chster</button>
      </div>
    </div>
  </main>

</div>

<script>
/* ===============
   Blackjack Deluxe
   - Single file, modern UI
   - Bets, Double, Split (einfache Umsetzung), Insurance
   - Card graphics via CSS
   - Bot KI heuristic
   - Sound via WebAudio
   =============== */

const fmt = v => (Math.round(v*100)/100);
const $ = id => document.getElementById(id);

/* ---------- Audio (WebAudio simple effects) ---------- */
let audioCtx = null;
let muted = false;
function ensureAudio(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function playClick(freq=700, type='sine', duration=0.08, vol=0.08){
  if(muted) return;
  ensureAudio();
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = vol;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + duration);
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
}

/* ---------- Deck & Player structures ---------- */
class Deck {
  constructor(){ this.reset(); }
  reset(){
    const suits = ['â™ ','â™¥','â™¦','â™£'];
    const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    this.cards = [];
    for(const s of suits) for(const r of ranks) this.cards.push({rank:r,suit:s});
    this.shuffle();
  }
  shuffle(){
    for(let i=this.cards.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
    }
  }
  draw(){ if(this.cards.length===0) this.reset(); return this.cards.pop(); }
}

class Hand {
  constructor(owner){ this.cards=[]; this.owner=owner; this.stand=false; this.busted=false; this.doubled=false; this.bet=0; this.insured=false; }
  addCard(c){ this.cards.push(c); this.recalc(); }
  recalc(){
    let sum=0, aces=0;
    for(const c of this.cards){
      if(c.rank==='A'){ aces++; sum+=1; }
      else if(['J','Q','K'].includes(c.rank)) sum+=10;
      else sum+=parseInt(c.rank,10);
    }
    for(let i=0;i<aces;i++){
      if(sum+10 <= 21) sum+=10;
    }
    this.value = sum;
    this.busted = sum>21;
    this.blackjack = (this.cards.length===2 && sum===21);
  }
}

/* Player: may have multiple hands (when split) */
class Player {
  constructor(name,type='human',bank=1000){ this.name=name; this.type=type; this.bank=bank; this.hands=[]; this.activeHandIndex=0; }
  resetForRound(){ this.hands=[]; this.activeHandIndex=0; }
  newHand(bet=0){ const h = new Hand(this); h.bet=bet; this.hands.push(h); return h; }
  currentHand(){ return this.hands[this.activeHandIndex]; }
  advanceHand(){ if(this.activeHandIndex < this.hands.length-1) { this.activeHandIndex++; return true; } return false; }
}

/* ---------- Global state ---------- */
let deck = new Deck();
let players = []; // array of Player
let dealer = null;
let currentPlayerIdx = 0; // index in players
let inRound = false;
let selectedChip = 25;
const logEl = $('log');
const playersConfigEl = $('playersConfig');
const playersLanesEl = $('playersLanes');
const dealerHandsEl = $('dealerHands');
const dealerValueEl = $('dealerValue');
const dealerSub = $('dealerSub');
const globalBankEl = $('globalBank');

/* ---------- UI helpers ---------- */
function log(msg){
  const d = document.createElement('div');
  d.textContent = `[${(new Date()).toLocaleTimeString()}] ${msg}`;
  logEl.prepend(d);
  playClick(900, 'sine', 0.04, 0.03);
}
function clearLog(){ logEl.innerHTML=''; }
function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }

/* ---------- Setup UI rendering ---------- */
function renderPlayersConfig(){
  playersConfigEl.innerHTML='';
  const n = parseInt($('numPlayers').value,10) || 1;
  const botRate = parseInt($('defaultBotRate').value,10) || 0;
  for(let i=0;i<n;i++){
    const div = document.createElement('div'); div.className='player-config';
    const name = document.createElement('input'); name.type='text'; name.value=`Player ${i+1}`;
    const typeSel = document.createElement('select');
    const o1 = document.createElement('option'); o1.value='human'; o1.text='Mensch';
    const o2 = document.createElement('option'); o2.value='bot'; o2.text='Bot';
    typeSel.appendChild(o1); typeSel.appendChild(o2);
    if(i < botRate) typeSel.value='bot';
    const bank = document.createElement('input'); bank.type='number'; bank.value=$('startBank').value; bank.min=0; bank.style.width='100px';
    div.appendChild(name); div.appendChild(typeSel); div.appendChild(bank);
    playersConfigEl.appendChild(div);
  }
}
$('numPlayers').addEventListener('change', renderPlayersConfig);
$('defaultBotRate').addEventListener('change', renderPlayersConfig);
$('startBank').addEventListener('change', renderPlayersConfig);
$('setupBtn').addEventListener('click', renderPlayersConfig);
renderPlayersConfig();

/* ---------- Build players from UI ---------- */
function buildPlayersFromUI(){
  players = [];
  const children = Array.from(playersConfigEl.children);
  for(const ch of children){
    const name = ch.querySelector('input[type=text]').value || 'Player';
    const type = ch.querySelector('select').value;
    const bank = parseInt(ch.querySelector('input[type=number]').value,10) || 1000;
    players.push(new Player(name, type, bank));
  }
  // Dealer
  dealer = new Player('Dealer','dealer', Infinity);
  dealer.newHand(0); // single dealer hand
  currentPlayerIdx = 0;
  updateGlobalBankDisplay();
  renderAllLanes();
}

/* ---------- Render lanes (dealer + players) ---------- */
function renderAllLanes(){
  // dealer
  dealerHandsEl.innerHTML='';
  const dealerHand = dealer.hands[0];
  for(let i=0;i<dealerHand.cards.length;i++){
    const c = dealerHand.cards[i];
    const cardEl = createCardElement(c, (inRound && i===1 && !dealer.revealed));
    dealerHandsEl.appendChild(cardEl);
  }
  dealerValueEl.textContent = inRound && dealer.revealed ? `â†’ ${dealerHand.value}` : '';

  // players
  playersLanesEl.innerHTML='';
  for(let pi=0; pi<players.length; pi++){
    const p = players[pi];
    const lane = document.createElement('div'); lane.className = 'lane ' + (p.type==='human' ? 'human' : 'bot');
    const meta = document.createElement('div'); meta.className='player-meta';
    const title = document.createElement('div'); title.className='player-title';
    title.innerHTML = `${p.name} <span style="font-size:0.8rem;color:#bfeee1;font-weight:600">(${p.bank}â‚¬)</span>`;
    const sub = document.createElement('div'); sub.className='player-sub'; sub.textContent = (pi===currentPlayerIdx && inRound) ? 'Am Zug' : 'Warten';
    meta.appendChild(title); meta.appendChild(sub);

    const handsWrap = document.createElement('div'); handsWrap.className='hand-area';
    for(let hi=0; hi<p.hands.length; hi++){
      const h = p.hands[hi];
      const handBox = document.createElement('div'); handBox.style.display='flex'; handBox.style.flexDirection='column'; handBox.style.alignItems='center';
      const cardsWrap = document.createElement('div'); cardsWrap.style.display='flex'; cardsWrap.style.gap='8px';
      for(let ci=0; ci<h.cards.length; ci++){
        const c = h.cards[ci];
        const dark = false;
        const cardEl = createCardElement(c, false);
        cardsWrap.appendChild(cardEl);
      }
      const info = document.createElement('div'); info.style.marginTop='6px'; info.style.fontWeight='700';
      info.textContent = `${h.value || 0} (${h.bet}â‚¬)` + (h.busted ? ' BUST' : h.blackjack ? ' BJ' : '');
      handBox.appendChild(cardsWrap);
      handBox.appendChild(info);
      handsWrap.appendChild(handBox);
    }

    lane.appendChild(meta);
    lane.appendChild(handsWrap);
    lane.appendChild(document.createElement('div'));
    playersLanesEl.appendChild(lane);
  }
}

/* create a styled card element (CSS) */
function createCardElement(card, hidden=false){
  const el = document.createElement('div');
  el.className = 'card faceup' + (hidden ? ' hidden':'') + ((card && (card.suit==='â™¥' || card.suit==='â™¦')) ? ' red' : '');
  if(hidden){ el.textContent=''; return el; }
  const top = document.createElement('div'); top.className='rank'; top.textContent = card.rank;
  const mid = document.createElement('div'); mid.className='suit'; mid.textContent = card.suit;
  const bot = document.createElement('div'); bot.className='rank'; bot.textContent = card.rank;
  el.appendChild(top); el.appendChild(mid); el.appendChild(bot);
  // hover animation
  el.onmouseenter = ()=> { el.style.transform='translateY(-6px) scale(1.02)'; el.style.boxShadow='0 18px 40px rgba(0,0,0,0.6)'; };
  el.onmouseleave = ()=> { el.style.transform='none'; el.style.boxShadow='0 8px 18px rgba(2,8,16,0.6)'; };
  return el;
}

/* ---------- Betting UI ---------- */
document.querySelectorAll('.chip').forEach(ch => {
  ch.addEventListener('click', (e)=>{
    document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
    ch.classList.add('active');
    selectedChip = parseInt(ch.dataset.value,10);
    playClick(1200, 'square', 0.05, 0.06);
  });
});
/* set default active chip */
document.querySelector('.chip[data-value="25"]').classList.add('active');

/* ---------- Game flow: start round / deal / player actions ---------- */
$('startBtn').addEventListener('click', ()=>{
  buildPlayersFromUI();
  hideSetup(true);
  // enable deal button
  $('dealBtn').disabled = false;
  $('dealBtn').focus();
  log('Setup abgeschlossen. Bereit zum Geben.');
});

/* hide or show setup pane */
function hideSetup(hide){
  const sidebar = $('sidebar');
  if(hide){ sidebar.style.opacity = 0; sidebar.style.pointerEvents='none'; sidebar.style.width='0'; }
  else { sidebar.style.opacity='1'; sidebar.style.pointerEvents='auto'; sidebar.style.width=''; }
}

/* DEAL */
$('dealBtn').addEventListener('click', ()=>{
  if(inRound){ log('Runde lÃ¤uft bereits.'); return; }
  // Take bets: for simplicity: each human must bet at least selectedChip; bots auto-bet min(selectedChip)
  for(const p of players){
    p.resetForRound();
    const bet = Math.max(selectedChip, 10); // min 10
    if(p.type==='human'){ // try to take from bank
      const actual = Math.min(bet, p.bank);
      p.bank -= actual;
      p.newHand(actual);
    } else {
      // bot bet: small randomization
      const b = Math.min(p.bank, Math.max(10, Math.round(selectedChip * (1 + (Math.random()-0.4)))));
      p.bank -= b;
      p.newHand(b);
    }
  }
  // dealer new hand
  dealer.resetForRound();
  dealer.newHand(0);
  // reset deck occasionally
  if(deck.cards.length < 60) deck.reset();
  // initial deal: 2 cards to each player's first hand, dealer 2 cards (1 hidden)
  for(let r=0;r<2;r++){
    for(const p of players){
      p.hands[0].addCard(deck.draw());
    }
    dealer.hands[0].addCard(deck.draw());
  }
  // special: if dealer's upcard is Ace -> allow insurance prompt briefly
  inRound = true;
  dealer.revealed = false;
  currentPlayerIdx = 0;
  clearLog();
  log('Karten verteilt. Runde gestartet.');
  renderAllLanes();
  renderDealer();
  updateGlobalBankDisplay();
  $('dealBtn').disabled = true;
  $('nextBtn').disabled = false;
  // auto-play bots if first
  processCurrentPlayer();
});

/* render dealer lane (with hidden second card if not revealed) */
function renderDealer(){
  dealerHandsEl.innerHTML='';
  const hand = dealer.hands[0];
  for(let i=0;i<hand.cards.length;i++){
    const card = hand.cards[i];
    const hidden = (i===1 && inRound && !dealer.revealed);
    dealerHandsEl.appendChild(createCardElement(card, hidden));
  }
  dealerValueEl.textContent = (inRound && dealer.revealed) ? `â†’ ${hand.value}` : (inRound ? 'â†’ ?' : '');
  dealerSub.textContent = (inRound ? (dealer.revealed ? 'Aufgedeckt' : 'Verdeckte Karte') : 'Bereit');
}

/* Next player button */
$('nextBtn').addEventListener('click', ()=>{
  // manual advance to next unsettled hand
  advanceToNext();
});

/* Player Actions */
$('btnHit').addEventListener('click', ()=> playerAction('hit'));
$('btnStand').addEventListener('click', ()=> playerAction('stand'));
$('btnDouble').addEventListener('click', ()=> playerAction('double'));
$('btnSplit').addEventListener('click', ()=> playerAction('split'));
$('btnInsure').addEventListener('click', ()=> playerAction('insure'));

function processCurrentPlayer(){
  if(!inRound) return;
  // if all players finished -> dealer plays
  if(players.every(p => p.hands.every(h => h.stand || h.busted || h.blackjack))){
    dealerPlay();
    return;
  }
  // ensure currentPlayerIdx points to a player with active unsettled hand
  let found=false;
  for(let i=0;i<players.length;i++){
    const idx = (currentPlayerIdx + i) % players.length;
    const p = players[idx];
    const h = p.currentHand();
    if(h && !h.stand && !h.busted && !h.blackjack){ currentPlayerIdx = idx; found=true; break; }
  }
  if(!found){ dealerPlay(); return; }
  renderAllLanes();
  const p = players[currentPlayerIdx];
  log(`Spieler ${p.name} ist dran.`);
  // If bot -> auto play with small delay using heuristic
  if(p.type === 'bot'){
    setTimeout(()=> botPlay(p), 650);
  }
}

/* Bot heuristic (improved) - simplified basic strategy */
function botPlay(p){
  // consider current hand only
  const h = p.currentHand();
  if(!h) { advanceToNext(); return; }
  // if can split and pair -> sometimes split
  if(h.cards.length===2 && h.cards[0].rank === h.cards[1].rank){
    if(h.cards[0].rank==='A' || h.cards[0].rank==='8'){
      // always split A and 8
      log(`${p.name} (Bot) entscheidet: Split`);
      playerActionFor(p, 'split'); return;
    }
  }
  // double conditions: if value 9-11 -> double often
  if(h.cards.length===2 && (h.value===9 || h.value===10 || h.value===11) && p.bank >= h.bet){
    if(Math.random() < 0.6){ log(`${p.name} (Bot) entscheidet: Double`); playerActionFor(p,'double'); return; }
  }
  // basic hit/stand:
  // if value >=17 stand, <=11 hit, 12-16 depends on dealer upcard
  const dealerUp = dealer.hands[0].cards[0];
  const dealerUpVal = getCardValueForStrategy(dealerUp);
  if(h.value <= 11){ log(`${p.name} (Bot) zieht`); playerActionFor(p,'hit'); return; }
  if(h.value >= 17){ log(`${p.name} (Bot) steht`); playerActionFor(p,'stand'); return; }
  // 12-16: stand if dealer shows 2-6 (bust-prone), else hit
  if(h.value >=12 && h.value <=16){
    if(dealerUpVal >=2 && dealerUpVal <=6){ log(`${p.name} (Bot) steht (dealer weak)`); playerActionFor(p,'stand'); return; }
    else { log(`${p.name} (Bot) zieht (dealer strong)`); playerActionFor(p,'hit'); return; }
  }
  // fallback
  playerActionFor(p,'stand');
}

/* Helper to map card to numeric for strategy (A treated as 11 here) */
function getCardValueForStrategy(card){
  if(!card) return 0;
  if(card.rank==='A') return 11;
  if(['J','Q','K'].includes(card.rank)) return 10;
  return parseInt(card.rank,10);
}

/* PlayerAction (UI triggered or bot) */
function playerAction(type){
  const p = players[currentPlayerIdx];
  playerActionFor(p, type);
}
function playerActionFor(p, type){
  const h = p.currentHand();
  if(!h){ advanceToNext(); return; }
  if(type==='hit'){
    const c = deck.draw(); h.addCard(c);
    playClick(1000, 'sine', 0.06, 0.06);
    log(`${p.name} zieht ${c.rank}${c.suit} â†’ ${h.value}`);
    if(h.busted){ log(`${p.name} ist busted! (${h.value})`); playClick(140, 'sine', 0.12, 0.09); }
    if(h.busted || h.stand || h.blackjack){ setTimeout(()=> { advanceToNext(); }, 500); }
    renderAllLanes();
  } else if(type==='stand'){
    h.stand = true;
    log(`${p.name} steht mit ${h.value}`);
    advanceToNext();
  } else if(type==='double'){
    // only allowed on first 2 cards
    if(h.cards.length !== 2){ log('Double nur auf den ersten 2 Karten erlaubt.'); return; }
    if(p.bank < h.bet){ log('Nicht genug Guthaben zum Verdoppeln.'); return; }
    p.bank -= h.bet; h.bet *= 2; h.doubled = true;
    const c = deck.draw(); h.addCard(c);
    log(`${p.name} verdoppelt und zieht ${c.rank}${c.suit} â†’ ${h.value}`);
    h.stand = true;
    renderAllLanes(); updateGlobalBankDisplay();
    setTimeout(()=> { advanceToNext(); }, 500);
  } else if(type==='split'){
    // only if two cards and same rank
    if(h.cards.length !== 2 || h.cards[0].rank !== h.cards[1].rank){ log('Split nur bei Paaren mÃ¶glich.'); return; }
    if(p.bank < h.bet){ log('Nicht genug Guthaben fÃ¼r Split.'); return; }
    // create new hand with second card
    p.bank -= h.bet;
    const second = h.cards.pop(); h.recalc();
    const newHand = p.newHand(h.bet);
    newHand.addCard(second);
    // draw one card to each hand
    h.addCard(deck.draw());
    newHand.addCard(deck.draw());
    log(`${p.name} splitet seine Hand (Wette: ${h.bet}â‚¬ pro Hand).`);
    renderAllLanes(); updateGlobalBankDisplay();
  } else if(type==='insure'){
    // Insurance: allow only when dealer upcard is Ace and insurance not already taken
    const dealerUp = dealer.hands[0].cards[0];
    if(!dealerUp || dealerUp.rank!=='A'){ log('Insurance nur bei Dealer Ass mÃ¶glich.'); return; }
    // pay half bet to insure
    if(p.bank < (h.bet/2)){ log('Nicht genug Guthaben fÃ¼r Insurance.'); return; }
    p.bank -= (h.bet/2); h.insured = true;
    log(`${p.name} kauft Insurance fÃ¼r ${h.bet/2}â‚¬ auf Hand (${h.bet}â‚¬).`);
    renderAllLanes(); updateGlobalBankDisplay();
  }
}

/* advance to next unsettled hand or player */
function advanceToNext(){
  const p = players[currentPlayerIdx];
  // try to advance current player's hand first
  if(p.advanceHand()){
    renderAllLanes();
    processCurrentPlayer();
    return;
  }
  // move to next player
  let idx = currentPlayerIdx;
  for(let i=1;i<=players.length;i++){
    const ni = (idx + i) % players.length;
    const np = players[ni];
    // find an unsettled hand in np
    if(np.hands.some(h=>!h.stand && !h.busted && !h.blackjack)){
      currentPlayerIdx = ni; renderAllLanes(); processCurrentPlayer(); return;
    }
  }
  // none found -> dealer plays
  dealerPlay();
}

/* ---------- Dealer logic ---------- */
function dealerPlay(){
  dealer.revealed = true;
  renderDealer();
  log('Dealer spielt jetzt.');
  // check for dealer blackjack immediate
  const dHand = dealer.hands[0];
  dHand.recalc();
  if(dHand.blackjack){
    log('Dealer hat Blackjack!');
    setTimeout(()=> finalizeRound(), 700);
    return;
  }
  // Dealer draws until 17 or more
  const playStep = ()=>{
    dHand.recalc();
    if(dHand.value < 17){
      const c = deck.draw(); dHand.addCard(c);
      log(`Dealer zieht ${c.rank}${c.suit} â†’ ${dHand.value}`);
      renderDealer();
      setTimeout(playStep, 700);
    } else {
      log(`Dealer steht mit ${dHand.value}`);
      renderDealer();
      setTimeout(()=> finalizeRound(), 400);
    }
  };
  setTimeout(playStep, 800);
}

/* ---------- Finalize round: compare hands, pay winners ---------- */
function finalizeRound(){
  const dVal = dealer.hands[0].value;
  const dBusted = dealer.hands[0].busted;
  log('--- Ergebnis ---');
  for(const p of players){
    for(const h of p.hands){
      if(h.busted){
        log(`${p.name} verliert Hand (${h.bet}â‚¬) - busted`);
        // insurance lost implicitly
        continue;
      }
      // insurance handling
      if(h.insured){
        if(dealer.hands[0].blackjack){
          // pays 2:1 on insured amount -> insurance pays h.bet/2 * 2 = h.bet
          const payout = h.bet; p.bank += payout;
          log(`${p.name} erhÃ¤lt Insurance payout ${payout}â‚¬`);
        } else {
          log(`${p.name} verliert Insurance.`);
        }
      }
      // blackjack vs dealer blackjack
      if(h.blackjack && !dealer.hands[0].blackjack){
        const payout = Math.round(h.bet * 2.5); // 3:2 payout approx
        p.bank += payout;
        log(`${p.name} Blackjack! Auszahlung ${payout}â‚¬`);
        continue;
      }
      if(h.blackjack && dealer.hands[0].blackjack){
        p.bank += h.bet; // push
        log(`${p.name} Push (beide Blackjack). Einsatz zurÃ¼ck.`);
        continue;
      }
      if(dBusted){
        // player wins
        const payout = h.bet * 2;
        p.bank += payout;
        log(`${p.name} gewinnt (Dealer busted). Auszahlung ${payout}â‚¬`);
        continue;
      }
      // normal compare
      if(h.value > dVal){
        const payout = h.bet * 2;
        p.bank += payout;
        log(`${p.name} gewinnt gegen Dealer (${h.value} vs ${dVal}). Auszahlung ${payout}â‚¬`);
      } else if(h.value === dVal){
        p.bank += h.bet;
        log(`${p.name} Push (${h.value}). Einsatz zurÃ¼ck.`);
      } else {
        log(`${p.name} verliert (${h.value} vs ${dVal}).`);
      }
    }
  }
  inRound = false;
  dealer.revealed = true;
  renderAllLanes();
  renderDealer();
  updateGlobalBankDisplay();
  $('dealBtn').disabled = false;
  $('nextBtn').disabled = true;
  log('Runde beendet. Du kannst neu geben.');
  // show setup again after short delay
  setTimeout(()=> hideSetup(false), 900);
}

/* update global bank display (sum or placeholder) */
function updateGlobalBankDisplay(){
  let txt = players.map(p => `${p.name}: ${p.bank}â‚¬`).join(' Â· ');
  globalBankEl.textContent = `Konten: ${txt}`;
}

/* mute toggle */
$('muteBtn').addEventListener('click', ()=>{
  muted = !muted;
  $('muteBtn').textContent = muted ? 'ðŸ”‡' : 'ðŸ”Š';
});

/* reset page */
$('resetBtn').addEventListener('click', ()=> location.reload());

/* keyboard shortcuts for quick testing */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'h') $('btnHit').click();
  if(e.key === 's') $('btnStand').click();
  if(e.key === 'd') $('btnDouble').click();
});

/* small startup */
log('Blackjack Deluxe geladen. Erzeuge Setup und starte das Spiel.');
</script>
</body>
</html>
